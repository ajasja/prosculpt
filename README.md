# prosculpt
Protein design and sculpting using Rosetta and Deep learning methods (RFDiff and Alphafold2)
## Description 
The script `rfdiff_mpnn_af2_discontinuous.py` runs a pipeline to automate the processes of generating protein structures with RFdiffusion, sequence generation with ProteinMPNN, and folding and evaluation with AF2 and Rosetta. Specifically, the script uses motif scaffolding to generate structures (see [RFdiffusion github repository](https://github.com/RosettaCommons/RFdiffusion/blob/main/README.md])).

The main steps are as follows:
1. The main inputs are a protein PDB file and a string that specifies how to generate the new structure around the original protein (which parts to keep, etc.) - this string is called a contig. 
2. The RFdiffusion module generates new protein structures based on the contig provided.
4. Generated PDB files are preprocessed using helper scripts and ProteinMPNN generates sequences for these structures.
5. Sequences are prepared for the AF2, which folds them into structures
6. Additional evaluation parameters are calculated for these structures using a separate script with Rosetta
7. The final output is a CSV file containing AF2 structure path, evaluation parameters etc.

## Requirements  
The script requires the prosculpt package. It assumes that RFdiffusion, proteinMPNN, and AF2 are installed and that the correct paths are provided in the script. Additionally, os, glob, argparse, re, and shutil packages should be installed.  
## Installation

  
## Running the script locally
To run the script, navigate to the directory containing the script and run the basic command in the command line (adjusted for your project):  
`python rfdiff_mpnn_af2_disontiuous.py --original_pdb_path /home/.../input_protein.pdb --output_dir /home/.../outputs/ --contig '[C33-60/4-7/A1-30/0 B61-120]' --num_designs_rfdiff 15 --num_seq_per_target_mpnn 5 --chains_to_design_mpnn 'A' `

Inputs: 
- `original_pdb_path`: original PDB around which the new structure is generated
- `contig`: explained in detail in the [RFdiffusion github repository](https://github.com/RosettaCommons/RFdiffusion/blob/main/README.md)  
- `output_dir`: output directory. Along the pipeline, each module will create its own subdirectory. The AF2 models are in the end renamed and copied to a subdirectory called `final_pdbs` 
- `num_designs_rfdiff`: number of structures generated by RFdiffusion
- `num_seq_per_target_mpnn`: number of sequences generated per one RFdiffusion structure (each sequence is by default folded 5 separate times by AF2)
- `chains_to_design_mpnn`: list chains for which MPNN should generate the sequence. If RFdiffusion generates a structure in two chains for example write `--chains_to_design_mpnn = 'A B'`

If symmetry is needed in the design process use  `rfdiff_mpnn_af2_simterija.py` script instead of `rfdiff_mpnn_af2_disontiuous.py`. In this case, add the argument `--symmetry` which specifies the type of symmetry and equals the number of peptides in the symmetrical complex. Important symmetry must equal the number of chains to design in the `contig` and `chains_to_design_mpnn` arguments.  

## Running in parallel on a CLUSTER 
To parallelize and speed up the design process you want to run the script on a CLUSTER. First using the `run_pipeline.py`script create a `.txt` file which contains the basic command to run the script repeated `n` times. `n` equals the number of tasks that are sent to separate compute nodes on the cluster.  
Then run the following command to send the tasks to the cluster  
`export GROUP_SIZE=1; sbatch --partition=gpu --gres=gpu:A40:1 --ntasks=1 --cpus-per-task=2 -J name_of_task  -a 1-number_of_tasks /home/.../scripts/wrapper_slurm_array_job_group.sh text_file_from_run_pipeline.txt`  
Make sure you have the `wrapper_slurm_array_job_group.sh` script installed.  
  
A note on outputs: when running on a cluster for each task a separate `final_outputs.csv` will be create. Run `merge_csv.py` along with the argument `--output_dir` to merge all csv files into one file.
## Examples for contigs
Contigs are the most important input (for now, guiding potentials are another input to be explored in the future). Here are a few guidelines to ease the start of your projects.
- For connecting two parts you could use a contig such as this: `'[A1-37/30-60/A42-70]'`. If the original PDB has another chain B, it will not be given to RFdiffusion in this case.
- For connecting two parts with respect to another structure you could use a contig such as this: `'[C33-60/4-7/B1-30/0 C61-120]'`. Chain B is given to RFdiffusion but no new structures are generated on it. Note: in the generated structure PDB the chains will be labeled as A (connected A and B) and B (C in original). 
- For connecting multiple chains you could use a contig such as this: `'[E10-68/5-15/C4-72/5-15/D78-145/5-15/A1-60/]' `
- For leveraging symmetry you could use a contig such as this: `'[10/A29-41/10/0 10/B29-41/10/0 10/C29-41/10]'`. In this case, the additional symmetry parameter must be: `--symmmetry = C3` (three subunits). Also, you cannot use contigs with interval lengths to be generated e.g. `'[10-20/A29-41/10-20]'`. Symmetry is not good enough for now, it needs some debugging in the MPNN module and optimization in guiding potentials of RFdiffusion.





